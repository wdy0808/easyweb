<!DOCTYPE html>
<meta charset="utf-8" />
<title>共同绘图</title>
<body>
<h2 id="state">{{connectstate}}</h2>
<canvas id="canvas" width="600" height="400">
    <span>您的浏览器不支持</span>
</canvas>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="https://cdn.bootcss.com/vue/2.4.2/vue.min.js"></script>
<script>
    var connect = new Vue({
        el: '#state',
        data: {
            connectstate: '连接中',
            mousestate: 'up'
        }
    })

    var oc = $('#canvas')[0]
    canvas = oc.getContext('2d')
    var lastimgData=canvas.getImageData(0,0,600,400)
    $('#canvas').on('mousedown', function(){
    /*开始绘制*/        
        canvas.beginPath();
        /*设置动画绘制起点坐标*/
        canvas.moveTo(event.pageX - 300 , event.pageY - 100);
        $('#canvas').on('mousemove', function(){
            /*设置下一个点坐标*/
            canvas.lineTo(event.pageX - 300 , event.pageY - 100);
            /*画线*/
            canvas.stroke();
        });
    }).on('mouseup', function(){
        $('#canvas').off('mousemove');
    });
    
    var ws = new WebSocket("ws://172.18.93.21:8888");
    ws.onopen = function(evt) {
        console.log("Connection");
        connect.connectstate = '成功连接服务器'
    };
    ws.onmessage = function(evt) {
        console.log("Received Message: " + evt.data);
    };
    ws.onclose = function(evt) {
        connect.connectstate = '连接断开'
        console.log("Connection closed.");
    };

    function doSend() {
        if (connect.connectstate == '成功连接服务器')
            ws.send(generationJson())
    }

    function generationJson() {
        var imageData = canvas.getImageData(0,0,oc.width,oc.height)
        var JsonValue = '{"type":"changeData","Data":['
        for (var i = 0; i < imageData.data.length; i += 4) {
            if (i > 0)
                JsonValue += ','
            JsonValue = JsonValue + '{"pos":' + i + 
                ',"r":' + imageData.data[i] + 
                ',"g":' + imageData.data[i + 1] + 
                ',"b":' + imageData.data[i + 2] + 
                ',"a":' + imageData.data[i + 3] + 
                '}'
        }
        JsonValue += ']}'
        return JsonValue
    }
</script>
</body>
</html>