<!DOCTYPE html>
<meta charset="utf-8" />
<title>共同绘图</title>
<body>
<canvas id="canvas" width="600" height="400" style="border:grey 1px solid;">
    <span>您的浏览器不支持</span>
</canvas>
<h2 id="state">{{connectstate}}</h2>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="https://cdn.bootcss.com/vue/2.4.2/vue.min.js"></script>
<script>
    var connect = new Vue({
        el: '#state',
        data: {
            connectstate: '连接中',
            mousestate: 'up'
        }
    })

    setInterval(doSend,500)

    var oc = $('#canvas')[0]
    canvas = oc.getContext('2d')
    var lastimgData=canvas.getImageData(0,0,600,400)
    $('#canvas').on('mousedown', function(){
    /*开始绘制*/        
        canvas.beginPath();
        /*设置动画绘制起点坐标*/
        canvas.moveTo(event.pageX, event.pageY);
        $('#canvas').on('mousemove', function(){
            /*设置下一个点坐标*/
            canvas.lineTo(event.pageX , event.pageY);
            /*画线*/
            canvas.stroke();
        });
    }).on('mouseup', function(){
        $('#canvas').off('mousemove');
    });
    
    var ws = new WebSocket("ws://172.18.93.21:8888");
    ws.onopen = function(evt) {
        console.log("Connection");
        connect.connectstate = '成功连接服务器'
    };
    ws.onmessage = function(evt) {
        var newImage = JSON.parse(evt.data)
        console.log(typeof(newImage));
        if (newImage["type"] == "changeData")
        {
            var newData = newImage.data
            var temImageData = canvas.getImageData(0,0,oc.width,oc.height)
            for (var i = 0; i < newData.length; i++)
            {
                console.log(newData[i].pos);
                lastimgData.data[newData[i].pos] = newData[i].value
                temImageData.data[newData[i].pos] = newData[i].value
            }
            canvas.putImageData(temImageData,0,0);
        }
    };
    ws.onclose = function(evt) {
        connect.connectstate = '连接断开'
        console.log("Connection closed.");
    };

    function doSend() {
        if (connect.connectstate == '成功连接服务器')
            ws.send(generationJson())
    }

    function generationJson() {
        var first = false;
        var imageData = canvas.getImageData(0,0,oc.width,oc.height)
        var JsonValue = '{"type":"changeData","data":['
        for (var i = 0; i < imageData.data.length; i++) {
            if (imageData.data[i] != lastimgData.data[i])
            {
                if (first)
                    JsonValue += ','
                else 
                    first = true
                JsonValue = JsonValue + '{"pos":' + i + ',"value":' + imageData.data[i] + '}'
            }
            
        }
        JsonValue += ']}'
        lastimgData = imageData
        return JsonValue
    }
</script>
</body>
</html>